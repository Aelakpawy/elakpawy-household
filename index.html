import React, { useEffect, useMemo, useState } from "react";
import { Card, CardContent } from "@/components/ui/card";
import { Button } from "@/components/ui/button";
import { Input } from "@/components/ui/input";
import { Tabs, TabsList, TabsTrigger, TabsContent } from "@/components/ui/tabs";
import { Dialog, DialogTrigger, DialogContent, DialogHeader, DialogTitle, DialogFooter } from "@/components/ui/dialog";
import { Label } from "@/components/ui/label";
import { Download, Plus, Trash, PenLine, Upload, PieChart as PieIcon, BarChart3, Save, RefreshCw } from "lucide-react";
import { PieChart, Pie, Cell, ResponsiveContainer, Tooltip as ReTooltip, Legend, BarChart, Bar, XAxis, YAxis, CartesianGrid, LineChart, Line } from "recharts";
import { motion } from "framer-motion";

/**
 * Personal Finance Dashboard (single-file React component)
 * - Preloaded demo data for Income & Expenses
 * - Instant charts: Expense Breakdown (Pie), Monthly Cashflow (Bar), Net Worth over time (Line)
 * - Inline editing, add/remove rows, category tagging
 * - Auto totals, savings rate, and net balance
 * - LocalStorage persistence
 * - Import/Export JSON
 * - Clean Tailwind + shadcn UI
 */

// ---- Helpers ----
const LS_KEY = "finance-dashboard-v1";

const demoData = {
  incomes: [
    { id: crypto.randomUUID(), date: "2025-08-01", source: "Salary", amount: 4200 },
    { id: crypto.randomUUID(), date: "2025-08-15", source: "Freelance", amount: 650 },
  ],
  expenses: [
    { id: crypto.randomUUID(), date: "2025-08-02", category: "Rent", note: "Munich flat", amount: 1500 },
    { id: crypto.randomUUID(), date: "2025-08-03", category: "Groceries", note: "REWE/EDEKA", amount: 320 },
    { id: crypto.randomUUID(), date: "2025-08-04", category: "Transport", note: "MVV", amount: 80 },
    { id: crypto.randomUUID(), date: "2025-08-05", category: "Dining", note: "Lunch & coffee", amount: 140 },
    { id: crypto.randomUUID(), date: "2025-08-08", category: "Subscriptions", note: "iCloud, Netflix", amount: 35 },
    { id: crypto.randomUUID(), date: "2025-08-10", category: "Healthcare", note: "Insurance", amount: 220 },
  ],
  netWorthHistory: [
    { month: "2025-04", value: 7200 },
    { month: "2025-05", value: 8150 },
    { month: "2025-06", value: 8920 },
    { month: "2025-07", value: 9480 },
    { month: "2025-08", value: 10350 },
  ],
};

function useLocalState() {
  const [data, setData] = useState(() => {
    try {
      const saved = localStorage.getItem(LS_KEY);
      return saved ? JSON.parse(saved) : demoData;
    } catch {
      return demoData;
    }
  });
  useEffect(() => {
    localStorage.setItem(LS_KEY, JSON.stringify(data));
  }, [data]);
  return [data, setData];
}

function currency(n) {
  if (Number.isNaN(Number(n))) return "€0";
  return new Intl.NumberFormat("de-DE", { style: "currency", currency: "EUR", maximumFractionDigits: 0 }).format(Number(n));
}

function monthKey(isoDate) {
  return isoDate?.slice(0, 7) ?? ""; // YYYY-MM
}

export default function FinanceDashboard() {
  const [data, setData] = useLocalState();
  const [tab, setTab] = useState("dashboard");
  const totalIncome = useMemo(() => data.incomes.reduce((a, b) => a + Number(b.amount || 0), 0), [data]);
  const totalExpense = useMemo(() => data.expenses.reduce((a, b) => a + Number(b.amount || 0), 0), [data]);
  const net = totalIncome - totalExpense;
  const savingsRate = totalIncome ? Math.max(0, Math.min(100, Math.round((net / totalIncome) * 100))) : 0;

  const expenseByCategory = useMemo(() => {
    const m = new Map();
    data.expenses.forEach((e) => m.set(e.category, (m.get(e.category) || 0) + Number(e.amount || 0)));
    return Array.from(m, ([name, value]) => ({ name, value }));
  }, [data.expenses]);

  const months = useMemo(() => {
    const set = new Set([...data.incomes, ...data.expenses].map((r) => monthKey(r.date)).filter(Boolean));
    return Array.from(set).sort();
  }, [data]);

  const cashflowByMonth = useMemo(() => {
    const map = new Map();
    months.forEach((m) => map.set(m, { month: m, income: 0, expense: 0, net: 0 }));
    data.incomes.forEach((r) => {
      const k = monthKey(r.date);
      if (!map.has(k)) map.set(k, { month: k, income: 0, expense: 0, net: 0 });
      map.get(k).income += Number(r.amount || 0);
    });
    data.expenses.forEach((r) => {
      const k = monthKey(r.date);
      if (!map.has(k)) map.set(k, { month: k, income: 0, expense: 0, net: 0 });
      map.get(k).expense += Number(r.amount || 0);
    });
    map.forEach((v) => (v.net = v.income - v.expense));
    return Array.from(map.values()).sort((a, b) => a.month.localeCompare(b.month));
  }, [data, months]);

  // ---- CRUD helpers ----
  const addIncome = () =>
    setData((d) => ({ ...d, incomes: [...d.incomes, { id: crypto.randomUUID(), date: new Date().toISOString().slice(0, 10), source: "Other", amount: 0 }] }));
  const addExpense = () =>
    setData((d) => ({ ...d, expenses: [...d.expenses, { id: crypto.randomUUID(), date: new Date().toISOString().slice(0, 10), category: "Misc", note: "", amount: 0 }] }));

  const updateRow = (type, id, field, value) => {
    setData((d) => ({
      ...d,
      [type]: d[type].map((r) => (r.id === id ? { ...r, [field]: field === "amount" ? Number(value || 0) : value } : r)),
    }));
  };
  const deleteRow = (type, id) => setData((d) => ({ ...d, [type]: d[type].filter((r) => r.id !== id) }));

  // ---- Import/Export ----
  const exportJSON = () => {
    const blob = new Blob([JSON.stringify(data, null, 2)], { type: "application/json" });
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href = url;
    a.download = "finance-data.json";
    a.click();
    URL.revokeObjectURL(url);
  };

  const onImportFile = (file) => {
    const reader = new FileReader();
    reader.onload = () => {
      try {
        const parsed = JSON.parse(reader.result);
        if (parsed && parsed.incomes && parsed.expenses) setData(parsed);
      } catch (e) {
        alert("Invalid JSON file.");
      }
    };
    reader.readAsText(file);
  };

  const resetDemo = () => setData(demoData);

  // ---- Colors for Pie (will use default recharts palette if not provided, but keeping a small set) ----
  const COLORS = ["#8884d8", "#82ca9d", "#ffc658", "#8dd1e1", "#a4de6c", "#d0ed57", "#ffc0cb", "#b0e0e6"]; // fallback palette

  return (
    <div className="min-h-screen bg-gray-50 p-6">
      <div className="max-w-7xl mx-auto space-y-6">
        <header className="flex flex-col md:flex-row md:items-center md:justify-between gap-4">
          <div>
            <h1 className="text-3xl font-bold">Personal Finance Dashboard</h1>
            <p className="text-gray-600">Elite UX with live charts, preloaded data, and instant totals.</p>
          </div>
          <div className="flex gap-2">
            <Button onClick={exportJSON} className="gap-2" variant="secondary"><Download className="w-4 h-4"/>Export</Button>
            <Dialog>
              <DialogTrigger asChild>
                <Button className="gap-2" variant="secondary"><Upload className="w-4 h-4"/>Import</Button>
              </DialogTrigger>
              <DialogContent>
                <DialogHeader>
                  <DialogTitle>Import data (JSON)</DialogTitle>
                </DialogHeader>
                <input type="file" accept="application/json" onChange={(e) => e.target.files?.[0] && onImportFile(e.target.files[0])} />
                <DialogFooter>
                  <Button variant="secondary">Done</Button>
                </DialogFooter>
              </DialogContent>
            </Dialog>
            <Button onClick={resetDemo} className="gap-2" variant="outline"><RefreshCw className="w-4 h-4"/>Reset Demo</Button>
          </div>
        </header>

        {/* KPIs */}
        <div className="grid grid-cols-1 md:grid-cols-4 gap-4">
          <StatCard title="Total Income" value={currency(totalIncome)} subtitle="This period" />
          <StatCard title="Total Expenses" value={currency(totalExpense)} subtitle="This period" />
          <StatCard title="Net" value={currency(net)} subtitle="Income − Expenses" positive={net>=0} />
          <StatCard title="Savings Rate" value={`${savingsRate}%`} subtitle="of income saved" />
        </div>

        <Tabs value={tab} onValueChange={setTab} className="mt-2">
          <TabsList className="grid grid-cols-3 md:w-[480px]">
            <TabsTrigger value="dashboard" className="gap-2"><BarChart3 className="w-4 h-4"/>Dashboard</TabsTrigger>
            <TabsTrigger value="incomes">Incomes</TabsTrigger>
            <TabsTrigger value="expenses">Expenses</TabsTrigger>
          </TabsList>
          <TabsContent value="dashboard" className="mt-4">
            <div className="grid grid-cols-1 lg:grid-cols-3 gap-4">
              <Card className="col-span-1 lg:col-span-1">
                <CardContent className="p-4">
                  <h3 className="font-semibold mb-2 flex items-center gap-2"><PieIcon className="w-4 h-4"/>Expense Breakdown</h3>
                  <div className="h-72">
                    <ResponsiveContainer width="100%" height="100%">
                      <PieChart>
                        <Pie data={expenseByCategory} dataKey="value" nameKey="name" outerRadius={110} label>
                          {expenseByCategory.map((entry, index) => (
                            <Cell key={`cell-${index}`} fill={COLORS[index % COLORS.length]} />
                          ))}
                        </Pie>
                        <ReTooltip formatter={(v) => currency(v)} />
                        <Legend />
                      </PieChart>
                    </ResponsiveContainer>
                  </div>
                </CardContent>
              </Card>

              <Card className="col-span-1 lg:col-span-2">
                <CardContent className="p-4">
                  <h3 className="font-semibold mb-2">Monthly Cashflow</h3>
                  <div className="h-72">
                    <ResponsiveContainer width="100%" height="100%">
                      <BarChart data={cashflowByMonth}>
                        <CartesianGrid strokeDasharray="3 3" />
                        <XAxis dataKey="month" />
                        <YAxis />
                        <ReTooltip formatter={(v) => currency(v)} />
                        <Legend />
                        <Bar dataKey="income" name="Income" />
                        <Bar dataKey="expense" name="Expenses" />
                      </BarChart>
                    </ResponsiveContainer>
                  </div>
                </CardContent>
              </Card>

              <Card className="col-span-1 lg:col-span-3">
                <CardContent className="p-4">
                  <h3 className="font-semibold mb-2">Net Worth Trend</h3>
                  <div className="h-72">
                    <ResponsiveContainer width="100%" height="100%">
                      <LineChart data={data.netWorthHistory}>
                        <CartesianGrid strokeDasharray="3 3" />
                        <XAxis dataKey="month" />
                        <YAxis />
                        <ReTooltip formatter={(v) => currency(v)} />
                        <Legend />
                        <Line dataKey="value" name="Net Worth" type="monotone" dot />
                      </LineChart>
                    </ResponsiveContainer>
                  </div>
                </CardContent>
              </Card>
            </div>
          </TabsContent>

          <TabsContent value="incomes" className="mt-4">
            <DataTable
              title="Incomes"
              cols={[
                { key: "date", label: "Date", type: "date" },
                { key: "source", label: "Source", type: "text" },
                { key: "amount", label: "Amount (€)", type: "number" },
              ]}
              rows={data.incomes}
              onChange={(id, field, value) => updateRow("incomes", id, field, value)}
              onDelete={(id) => deleteRow("incomes", id)}
              onAdd={addIncome}
            />
          </TabsContent>

          <TabsContent value="expenses" className="mt-4">
            <DataTable
              title="Expenses"
              cols={[
                { key: "date", label: "Date", type: "date" },
                { key: "category", label: "Category", type: "text" },
                { key: "note", label: "Note", type: "text" },
                { key: "amount", label: "Amount (€)", type: "number" },
              ]}
              rows={data.expenses}
              onChange={(id, field, value) => updateRow("expenses", id, field, value)}
              onDelete={(id) => deleteRow("expenses", id)}
              onAdd={addExpense}
              footer={<div className="text-sm text-gray-600">Tip: Categories power the pie chart automatically.</div>}
            />
          </TabsContent>
        </Tabs>
      </div>
    </div>
  );
}

function StatCard({ title, value, subtitle, positive }) {
  return (
    <Card>
      <CardContent className="p-4">
        <div className="text-sm text-gray-500">{title}</div>
        <motion.div initial={{ opacity: 0, y: 6 }} animate={{ opacity: 1, y: 0 }} transition={{ type: "spring", stiffness: 120 }}>
          <div className={`text-2xl font-semibold ${positive === true ? "text-emerald-600" : positive === false ? "text-rose-600" : ""}`}>{value}</div>
        </motion.div>
        {subtitle && <div className="text-xs text-gray-500 mt-1">{subtitle}</div>}
      </CardContent>
    </Card>
  );
}

function DataTable({ title, cols, rows, onChange, onDelete, onAdd, footer }) {
  return (
    <Card>
      <CardContent className="p-4">
        <div className="flex items-center justify-between mb-3">
          <h3 className="font-semibold">{title}</h3>
          <Button onClick={onAdd} className="gap-2"><Plus className="w-4 h-4"/>Add</Button>
        </div>
        <div className="overflow-x-auto">
          <table className="min-w-full text-sm">
            <thead>
              <tr className="text-left text-gray-600">
                {cols.map((c) => (
                  <th key={c.key} className="py-2 pr-4 font-medium">{c.label}</th>
                ))}
                <th className="py-2 pr-2">Actions</th>
              </tr>
            </thead>
            <tbody>
              {rows.map((r) => (
                <tr key={r.id} className="border-t">
                  {cols.map((c) => (
                    <td key={c.key} className="py-2 pr-4">
                      <CellEditor value={r[c.key]} type={c.type} onChange={(v) => onChange(r.id, c.key, v)} />
                    </td>
                  ))}
                  <td className="py-2 pr-2">
                    <Button variant="destructive" size="icon" onClick={() => onDelete(r.id)}>
                      <Trash className="w-4 h-4" />
                    </Button>
                  </td>
                </tr>
              ))}
            </tbody>
          </table>
        </div>
        {footer && <div className="mt-2">{footer}</div>}
      </CardContent>
    </Card>
  );
}

function CellEditor({ value, type, onChange }) {
  const common = {
    className: "w-full",
    value: value ?? "",
    onChange: (e) => onChange(e.target.value),
  };
  if (type === "date") return <Input type="date" {...common} />;
  if (type === "number") return <Input type="number" step="0.01" {...common} />;
  return <Input type="text" {...common} />;
}
